<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HabitFlow Dashboard</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#19e65e",
            background: "#0d1811",
            surface: "#16231b",
            borderc: "#2f4538"
          },
          fontFamily: {
            display: ["Manrope", "sans-serif"]
          }
        }
      }
    }
  </script>
</head>

<body class="bg-background text-white font-display overflow-hidden">

<div class="flex h-screen">

  <!-- SIDEBAR -->
  <aside class="w-64 bg-surface border-r border-borderc p-6 hidden md:flex flex-col">
    <h1 class="text-2xl font-bold mb-8">HabitFlow</h1>
    <nav class="flex flex-col gap-3 text-gray-400">
      <span class="text-primary font-bold">Dashboard</span>
      <span>Habits</span>
      <span>Calendar</span>
      <span>Settings</span>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 overflow-y-auto p-8 space-y-8">

    <!-- HEADER -->
    <div class="flex justify-between items-center">
      <h2 class="text-3xl font-bold">Overview</h2>
      <span id="dateDisplay" class="text-gray-400"></span>
    </div>

    <!-- METRICS -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-surface p-4 rounded-xl">
        <p class="text-gray-400 text-sm">Completion Rate</p>
        <p id="completionRate" class="text-3xl font-bold">0%</p>
      </div>
      <div class="bg-surface p-4 rounded-xl">
        <p class="text-gray-400 text-sm">Current Streak</p>
        <p id="streakCounter" class="text-3xl font-bold">ðŸ”¥ 0</p>
      </div>
      <div class="bg-surface p-4 rounded-xl">
        <p class="text-gray-400 text-sm">Total Habits</p>
        <p id="totalHabits" class="text-3xl font-bold">0</p>
      </div>
      <div class="bg-surface p-4 rounded-xl">
        <p class="text-gray-400 text-sm">Avg / Day</p>
        <p id="avgHabits" class="text-3xl font-bold">0</p>
      </div>
    </div>

    <!-- CHART -->
    <div class="bg-surface p-6 rounded-2xl">
      <h3 class="font-bold mb-4">Progress (Last 7 Days)</h3>
      <div class="h-[300px]">
        <canvas id="progressChart"></canvas>
      </div>
    </div>

    <!-- HABITS -->
    <div class="bg-surface p-6 rounded-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 id="journalTitle" class="font-bold text-xl">Today's Habits</h3>
        <button id="addHabitBtn" class="bg-primary text-black px-4 py-2 rounded-lg font-bold">Add Habit</button>
      </div>
      <ul id="habitList" class="space-y-3"></ul>
    </div>

    <!-- CALENDAR -->
    <div class="bg-surface p-6 rounded-2xl">
      <div class="flex justify-between items-center mb-4">
        <button id="prevMonth">â—€</button>
        <span id="currentMonth"></span>
        <button id="nextMonth">â–¶</button>
      </div>
      <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
    </div>

  </main>
</div>

<!-- FLOATING ADD -->
<button id="floatingAddBtn"
  class="fixed bottom-8 right-8 bg-primary text-black w-16 h-16 rounded-full text-3xl font-bold">+</button>

<!-- ADD HABIT MODAL -->
<div id="addHabitModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
  <form id="addHabitForm" class="bg-surface p-6 rounded-xl space-y-4 w-96">
    <h3 class="font-bold text-xl">Add Habit</h3>
    <input id="habitName" required class="w-full p-2 bg-black rounded" placeholder="Habit name"/>
    <textarea id="habitDescription" class="w-full p-2 bg-black rounded" placeholder="Description"></textarea>
    <select id="habitFrequency" class="w-full p-2 bg-black rounded">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
    </select>
    <button class="bg-primary text-black w-full py-2 font-bold rounded">Save</button>
  </form>
</div>

<!-- DELETE MODAL -->
<div id="deleteModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
  <div class="bg-surface p-6 rounded-xl w-96 space-y-4">
    <p>Delete <span id="deleteHabitName"></span>?</p>
    <button id="confirmDeleteBtn" class="bg-red-500 w-full py-2 rounded">Delete</button>
    <button id="cancelDeleteBtn" class="w-full py-2">Cancel</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-surface px-6 py-3 rounded hidden"></div>

<script>
/* ===============================
   SUPABASE
================================ */
const supabase = window.supabase.createClient(
  "https://jtpsnufycomhozsiegjh.supabase.co",
  "YOUR_PUBLIC_ANON_KEY"
);

/* ===============================
   DOM
================================ */
const addHabitBtn = document.getElementById("addHabitBtn");
const floatingAddBtn = document.getElementById("floatingAddBtn");
const addHabitModal = document.getElementById("addHabitModal");
const addHabitForm = document.getElementById("addHabitForm");
const habitList = document.getElementById("habitList");
const dateDisplay = document.getElementById("dateDisplay");
const journalTitle = document.getElementById("journalTitle");

const calendarGrid = document.getElementById("calendarGrid");
const currentMonth = document.getElementById("currentMonth");
const prevMonth = document.getElementById("prevMonth");
const nextMonth = document.getElementById("nextMonth");

const deleteModal = document.getElementById("deleteModal");
const deleteHabitName = document.getElementById("deleteHabitName");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");

/* ===============================
   STATE
================================ */
let habits = [];
let habitEntries = [];
let selectedDate = new Date();
let currentMonthDate = new Date();
let habitToDelete = null;
let progressChart = null;

/* ===============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", async () => {
  updateDateDisplay();
  renderCalendar();
  await loadData();
});

/* ===============================
   DATE
================================ */
function updateDateDisplay() {
  dateDisplay.textContent = selectedDate.toDateString();
  journalTitle.textContent =
    selectedDate.toDateString() === new Date().toDateString()
      ? "Today's Habits"
      : `Habits for ${selectedDate.toDateString()}`;
}

/* ===============================
   LOAD DATA
================================ */
async function loadData() {
  const { data: h } = await supabase.from("habits").select("*").eq("active", true);
  const { data: e } = await supabase.from("habit_entries").select("*");
  habits = h || [];
  habitEntries = e || [];
  renderHabits();
  updateAnalytics();
  updateProgressChart();
}

/* ===============================
   HABITS
================================ */
function renderHabits() {
  habitList.innerHTML = "";
  const dateStr = selectedDate.toISOString().split("T")[0];

  habits.forEach(habit => {
    const entry = habitEntries.find(e => e.habit_id === habit.id && e.date === dateStr);
    const completed = entry?.completed || false;

    const li = document.createElement("li");
    li.className = "flex items-center gap-3 bg-black/30 p-3 rounded-lg";

    li.innerHTML = `
      <input type="checkbox" ${completed ? "checked" : ""} />
      <span class="flex-1">${habit.name}</span>
      <span>ðŸ”¥ ${calculateStreak(habit.id)}</span>
      <button class="text-red-400">âœ•</button>
    `;

    li.querySelector("input").onchange = e =>
      toggleHabitCompletion(habit.id, e.target.checked, dateStr);

    li.querySelector("button").onclick = () => {
      habitToDelete = habit;
      deleteHabitName.textContent = habit.name;
      deleteModal.classList.remove("hidden");
    };

    habitList.appendChild(li);
  });

  document.getElementById("totalHabits").textContent = habits.length;
}

/* ===============================
   TOGGLE
================================ */
async function toggleHabitCompletion(habitId, completed, date) {
  const { data: existing } = await supabase
    .from("habit_entries")
    .select("*")
    .eq("habit_id", habitId)
    .eq("date", date)
    .single();

  if (existing) {
    await supabase.from("habit_entries").update({ completed }).eq("id", existing.id);
  } else {
    await supabase.from("habit_entries").insert([{ habit_id: habitId, date, completed }]);
  }
  loadData();
}

/* ===============================
   STREAK
================================ */
function calculateStreak(habitId) {
  const entries = habitEntries
    .filter(e => e.habit_id === habitId && e.completed)
    .sort((a, b) => new Date(b.date) - new Date(a.date));

  let streak = 0;
  let d = new Date(); d.setHours(0,0,0,0);

  for (const e of entries) {
    const ed = new Date(e.date); ed.setHours(0,0,0,0);
    if ((d - ed) / 86400000 === streak) streak++;
    else break;
  }
  return streak;
}

/* ===============================
   ANALYTICS
================================ */
function updateAnalytics() {
  const completed = habitEntries.filter(e => e.completed).length;
  document.getElementById("completionRate").textContent =
    habits.length ? Math.round((completed / (habits.length * 7)) * 100) + "%" : "0%";
  document.getElementById("avgHabits").textContent =
    completed ? (completed / 7).toFixed(1) : "0";

  const streaks = habits.map(h => calculateStreak(h.id));
  document.getElementById("streakCounter").textContent = "ðŸ”¥ " + Math.max(...streaks, 0);
}

/* ===============================
   CHART
================================ */
function updateProgressChart() {
  const ctx = document.getElementById("progressChart");
  if (progressChart) progressChart.destroy();

  const labels = [];
  const data = [];

  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toISOString().split("T")[0];
    labels.push(d.toLocaleDateString("en-US", { weekday: "short" }));
    data.push(habitEntries.filter(e => e.date === ds && e.completed).length);
  }

  progressChart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ data, borderColor: "#19e65e", fill: true }] },
    options: { plugins: { legend: { display: false } } }
  });
}

/* ===============================
   CALENDAR
================================ */
function renderCalendar() {
  calendarGrid.innerHTML = "";
  currentMonth.textContent = currentMonthDate.toLocaleDateString("en-US", { month: "long", year: "numeric" });

  const y = currentMonthDate.getFullYear();
  const m = currentMonthDate.getMonth();
  const first = new Date(y, m, 1).getDay();
  const days = new Date(y, m + 1, 0).getDate();

  for (let i = 0; i < first; i++) calendarGrid.appendChild(document.createElement("div"));

  for (let d = 1; d <= days; d++) {
    const el = document.createElement("div");
    el.textContent = d;
    el.className = "p-2 text-center rounded cursor-pointer hover:bg-primary/20";
    el.onclick = () => {
      selectedDate = new Date(y, m, d);
      updateDateDisplay();
      renderHabits();
      renderCalendar();
    };
    calendarGrid.appendChild(el);
  }
}

prevMonth.onclick = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() - 1); renderCalendar(); };
nextMonth.onclick = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() + 1); renderCalendar(); };

/* ===============================
   MODALS
================================ */
addHabitBtn.onclick = floatingAddBtn.onclick = () =>
  addHabitModal.classList.remove("hidden");

addHabitForm.onsubmit = async e => {
  e.preventDefault();
  await supabase.from("habits").insert([{
    name: habitName.value,
    description: habitDescription.value,
    frequency: habitFrequency.value,
    active: true
  }]);
  addHabitModal.classList.add("hidden");
  addHabitForm.reset();
  loadData();
};

confirmDeleteBtn.onclick = async () => {
  await supabase.from("habit_entries").delete().eq("habit_id", habitToDelete.id);
  await supabase.from("habits").delete().eq("id", habitToDelete.id);
  deleteModal.classList.add("hidden");
  loadData();
};

cancelDeleteBtn.onclick = () => deleteModal.classList.add("hidden");
</script>

</body>
</html>
